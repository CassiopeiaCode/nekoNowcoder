# Factorio - é¢˜è§£

### æ ‡ç­¾ä¸éš¾åº¦
> **æ ‡ç­¾**: å›¾è®º, æ‹“æ‰‘æ’åº, æœ‰å‘æ— ç¯å›¾(DAG), é«˜ç²¾åº¦è®¡ç®—, æ¨¡æ‹Ÿ, æ•°æ®ç»“æ„
> **éš¾åº¦**: 2100

## å˜¿ï¼Œæ˜¯é¢˜ç›®å¤§æ„å–µ~

ä½ å¥½å‘€ï¼ŒæŒ‡æŒ¥å®˜ï¼ä»Šå¤©æˆ‘ä»¬æ¥åˆ°äº†ä¸€å®¶å«åš Factorio çš„ç¥å¥‡å·¥å‚ï¼Œè¿™é‡Œçš„ä¸€åˆ‡éƒ½éµå¾ªç€ç²¾ç¡®çš„ç”Ÿäº§é…æ–¹ï¼Œå–µ~ã€‚

å·¥å‚é‡Œæœ‰å„ç§å„æ ·çš„ç‰©å“ï¼Œå¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼š
1.  **è‡ªç„¶èµ„æº**: åƒé“çŸ¿çŸ³ã€é“œçŸ¿çŸ³ä¸€æ ·ï¼Œæ˜¯ä»åœ°é‡ŒæŒ–å‡ºæ¥çš„ï¼Œæ˜¯æ‰€æœ‰ç”Ÿäº§é“¾çš„æœ€å¼€ç«¯ã€‚å®ƒä»¬åªèƒ½è¢«ç”¨ä½œåŸæ–™ã€‚
2.  **ä¸­é—´äº§å“**: ç”±ä¸€äº›åŸæ–™ï¼ˆå¯èƒ½æ˜¯è‡ªç„¶èµ„æºæˆ–å…¶ä»–ä¸­é—´äº§å“ï¼‰é€šè¿‡**è£…é…æœº**åˆæˆã€‚æ¯”å¦‚ç”¨é“œå¯ä»¥é€ å‡ºç”µç¼†ã€‚
3.  **æœ€ç»ˆäº§å“**: æ•´ä¸ªå·¥å‚çš„ç›®æ ‡ï¼å®ƒæ˜¯å”¯ä¸€ä¸€ç§ä¸ä¼šè¢«ç”¨æ¥åˆ¶é€ å…¶ä»–ä»»ä½•ä¸œè¥¿çš„äº§å“ã€‚

æ¯ä¸ªç‰©å“çš„ç”Ÿäº§éƒ½ç”±**è£…é…æœº**æˆ–**é‡‡çŸ¿æœº**è´Ÿè´£ã€‚æˆ‘ä»¬æ‰‹å¤´æœ‰ä¸€ä»½æ¸…å•ï¼Œè®°å½•äº†æ¯ç§ç‰©å“æœ‰å¤šå°‘å°ä¸“å±çš„ç”Ÿäº§æœºå™¨ã€‚

ç”Ÿäº§å…³ç³»ç”±ä¸€ç³»åˆ—**é…æ–¹**å†³å®šï¼Œå½¢å¦‚ï¼š
`c1 åŸæ–™1 + c2 åŸæ–™2 + ... = c_p äº§å“p`
è¿™æ„å‘³ç€éœ€è¦ `c1` ä»½åŸæ–™1ï¼Œ`c2` ä»½åŸæ–™2... æ‰èƒ½åˆæˆå‡º `c_p` ä»½äº§å“pã€‚

æˆ‘ä»¬çš„ä»»åŠ¡æ˜¯æ‰¾å‡ºå·¥å‚çš„ **â€œç”Ÿäº§ç“¶é¢ˆâ€**ã€‚è¿™æ˜¯ä¸ªä»€ä¹ˆæ¦‚å¿µå‘¢ï¼Ÿå–µ~ï¼Ÿ
ç®€å•æ¥è¯´ï¼Œç“¶é¢ˆå°±æ˜¯é‚£äº›**æœ€æœ€æœ€é™åˆ¶**æˆ‘ä»¬æœ€ç»ˆäº§å“äº§é‡çš„ç‰©å“ã€‚å¦‚æœæˆ‘ä»¬ç»™è¿™äº›ç“¶é¢ˆç‰©å“å¢åŠ ä¸€å°ç”Ÿäº§æœºå™¨ï¼Œæ•´ä¸ªå·¥å‚çš„æœ€é«˜ç”Ÿäº§æ•ˆç‡å°±èƒ½å¾—åˆ°æå‡ã€‚åä¹‹ï¼Œå¦‚æœç»™éç“¶é¢ˆç‰©å“å¢åŠ æœºå™¨ï¼Œåˆ™å®Œå…¨æ²¡ç”¨ï¼Œå› ä¸ºæœ‰å…¶ä»–ä¸œè¥¿é™åˆ¶å¾—æ›´å‰å®³ã€‚

æˆ‘ä»¬è¦åšçš„å°±æ˜¯ï¼Œæ ¹æ®ç»™å®šçš„æœºå™¨æ•°é‡å’Œç”Ÿäº§é…æ–¹ï¼Œæ‰¾å‡ºæ‰€æœ‰æ„æˆè¿™ä¸ªâ€œç”Ÿäº§ç“¶é¢ˆâ€çš„ç‰©å“ï¼Œå¹¶æŒ‰å­—æ¯é¡ºåºåˆ—å‡ºå®ƒä»¬ã€‚

## è§£é¢˜æ€è·¯åˆ†æ

è¿™é“é¢˜çœ‹èµ·æ¥æœ‰ç‚¹å¤æ‚ï¼Œä¿¡æ¯é‡å¥½å¤§å‘€ï¼Œå–µ~ï¼ä¸è¿‡åˆ«æ€•ï¼Œè®©æœ¬æˆ‘æ¥æŠŠé—®é¢˜æ‹†è§£æˆä¸€å°å—ä¸€å°å—çš„çŒ«çˆªé¥¼å¹²ï¼Œæˆ‘ä»¬ä¸€å—ä¸€å—åƒæ‰å®ƒï¼

### 1. æŠŠå·¥å‚æŠ½è±¡æˆä¸€å¼ å›¾

é¦–å…ˆï¼Œç‰©å“ä¹‹é—´çš„ç”Ÿäº§å…³ç³»ï¼Œå¤©ç„¶å°±æ˜¯ä¸€å¼ **æœ‰å‘å›¾**ï¼æ¯ä¸ªç‰©å“ï¼ˆæ— è®ºæ˜¯èµ„æºã€ä¸­é—´äº§å“è¿˜æ˜¯æœ€ç»ˆäº§å“ï¼‰éƒ½æ˜¯å›¾ä¸Šçš„ä¸€ä¸ªèŠ‚ç‚¹ã€‚

å¦‚æœç‰©å“ `A` æ˜¯ç”Ÿäº§ç‰©å“ `B` çš„ç›´æ¥åŸæ–™ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿ä¸€æ¡ä» `B` åˆ° `A` çš„æœ‰å‘è¾¹ `B -> A`ã€‚è¿™è¡¨ç¤ºâ€œæƒ³è¦Bï¼Œå°±å¾—å…ˆæœ‰Aâ€ã€‚è¿™æ ·ä¸€æ¥ï¼Œæ•´ä¸ªå·¥å‚çš„ç”Ÿäº§æµç¨‹å°±å˜æˆäº†ä¸€å¼ å·¨å¤§çš„**æœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰**ã€‚ä¸ºä»€ä¹ˆæ˜¯æ— ç¯çš„å‘¢ï¼Ÿå› ä¸ºä¸€ä¸ªäº§å“æ€»ä¸èƒ½è‡ªå·±ç”Ÿäº§è‡ªå·±å§ï¼Œé‚£ä¸æˆæ°¸åŠ¨æœºäº†ï¼Œå–µ~ã€‚

åœ¨è¿™å¼ å›¾é‡Œï¼š
*   **è‡ªç„¶èµ„æº** æ˜¯é‚£äº›æ²¡æœ‰å…¥è¾¹çš„èŠ‚ç‚¹ï¼ˆå®ƒä»¬ä¸æ˜¯ç”±å…¶ä»–ç‰©å“ç”Ÿäº§çš„ï¼‰ã€‚
*   **æœ€ç»ˆäº§å“** æ˜¯é‚£ä¸ªå”¯ä¸€çš„ã€æ²¡æœ‰å‡ºè¾¹çš„èŠ‚ç‚¹ï¼ˆå®ƒä¸è¢«ç”¨äºç”Ÿäº§ä»»ä½•å…¶ä»–ä¸œè¥¿ï¼‰ã€‚

### 2. é‡åŒ–éœ€æ±‚ï¼šç”Ÿäº§ä¸€ä¸ªæœ€ç»ˆäº§å“éœ€è¦å¤šå°‘åŸæ–™ï¼Ÿ

è¦æ‰¾åˆ°ç“¶é¢ˆï¼Œæˆ‘ä»¬å¾—å…ˆçŸ¥é“ä¸ºäº†ç”Ÿäº§ä¸€ä¸ªå•ä½çš„æœ€ç»ˆäº§å“ï¼Œåˆ°åº•éœ€è¦å¤šå°‘å•ä½çš„å„ç§å…¶ä»–ç‰©å“ã€‚æˆ‘ä»¬æŠŠè¿™ä¸ªéœ€æ±‚é‡å«åš `demand[i]`ï¼Œè¡¨ç¤ºç”Ÿäº§ 1 ä¸ªæœ€ç»ˆäº§å“éœ€è¦ `demand[i]` ä¸ªç‰©å“ `i`ã€‚

æ€ä¹ˆè®¡ç®—è¿™ä¸ª `demand` å€¼å‘¢ï¼Ÿè¿™æ˜¯ä¸€ä¸ªä»æœ€ç»ˆäº§å“å‘å‰è¿½æº¯çš„è¿‡ç¨‹ã€‚
*   å¯¹äºæœ€ç»ˆäº§å“ `FP`ï¼Œå®ƒçš„éœ€æ±‚é‡æ˜¾ç„¶æ˜¯ `demand[FP] = 1`ã€‚
*   å¯¹äºä»»ä½•ä¸€ä¸ªç‰©å“ `u`ï¼Œå‡è®¾å®ƒæ˜¯ç”Ÿäº§ç‰©å“ `v` çš„åŸæ–™ä¹‹ä¸€ï¼Œé…æ–¹æ˜¯ `... + c_u * u + ... = c_v * v`ã€‚è¿™æ„å‘³ç€ï¼Œæ¯å½“æˆ‘ä»¬éœ€è¦ `c_v` ä¸ª `v` æ—¶ï¼Œå°±éœ€è¦ `c_u` ä¸ª `u`ã€‚æ¢å¥è¯è¯´ï¼Œå¯¹ `v` çš„æ¯å•ä½éœ€æ±‚ï¼Œä¼šäº§ç”Ÿå¯¹ `u` çš„ `c_u / c_v` å•ä½çš„éœ€æ±‚ã€‚
*   æ‰€ä»¥ï¼Œä¸€ä¸ªç‰©å“ `u` çš„æ€»éœ€æ±‚é‡ï¼Œæ˜¯æ‰€æœ‰â€œä¸‹æ¸¸â€äº§å“å¯¹å®ƒäº§ç”Ÿçš„éœ€æ±‚ä¹‹å’Œã€‚
    $$
    \text{demand}[u] = \sum_{v \text{ where } u \text{ is a material for } v} \text{demand}[v] \times \frac{\text{count_of_u_for_v}}{\text{count_of_v_produced}}
    $$

è¿™ä¸ªè®¡ç®—è¿‡ç¨‹æ˜¯ä¸æ˜¯å¾ˆåƒåœ¨å›¾ä¸Šåå‘ä¼ æ’­ï¼Ÿæˆ‘ä»¬å¯ä»¥ä»æœ€ç»ˆäº§å“å¼€å§‹ï¼Œæ²¿ç€å›¾çš„è¾¹åå‘ï¼ˆä»äº§å“åˆ°åŸæ–™ï¼‰è¿›è¡Œè®¡ç®—ã€‚è¿™å¯ä»¥é€šè¿‡åœ¨**åå‘å›¾**ä¸Šè¿›è¡Œ**æ‹“æ‰‘æ’åº**æ¥å®ç°ã€‚ä¸€ä¸ªæ›´ç›´è§‚çš„æ–¹æ³•æ˜¯ï¼š

1.  å»ºç«‹ `äº§å“ -> åŸæ–™` çš„å›¾ `G`ã€‚åŒæ—¶è®°å½•æ¯ä¸ªç‰©å“è¢«å¤šå°‘ç§æ›´é«˜çº§çš„äº§å“å½“ä½œåŸæ–™ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º `usage_count[i]` (è¿™å…¶å®å°±æ˜¯åå›¾çš„å…¥åº¦ï¼Œæˆ–è€…åŸå›¾çš„å‡ºåº¦)ã€‚
2.  æ‰¾åˆ°æœ€ç»ˆäº§å“ `FP`ï¼ˆ`usage_count[FP] == 0` çš„é‚£ä¸ªèŠ‚ç‚¹ï¼‰ã€‚
3.  åˆå§‹åŒ–ä¸€ä¸ªé˜Ÿåˆ—ï¼ŒæŠŠ `FP` æ”¾è¿›å»ã€‚
4.  å½“é˜Ÿåˆ—ä¸ä¸ºç©ºæ—¶ï¼Œå–å‡ºé˜Ÿé¦–èŠ‚ç‚¹ `u`ã€‚å¯¹äº `u` çš„æ¯ä¸€ç§åŸæ–™ `v` (å³ `u -> v`):
    a. æ ¹æ®é…æ–¹ï¼Œæ›´æ–° `v` çš„éœ€æ±‚ï¼š`demand[v] += demand[u] * (c_v / c_u)`ã€‚
    b. `v` çš„ä¸€ä¸ªâ€œä¸‹æ¸¸â€å·²ç»è¢«æˆ‘ä»¬è®¡ç®—å®Œäº†ï¼Œæ‰€ä»¥ `usage_count[v]--`ã€‚
    c. å¦‚æœ `usage_count[v]` å‡åˆ° 0ï¼Œè¯´æ˜æ‰€æœ‰éœ€è¦ `v` çš„äº§å“éƒ½å·²è¢«å¤„ç†ï¼Œ`v` çš„æ€»éœ€æ±‚å·²ç»è®¡ç®—å®Œæ¯•ã€‚æ­¤æ—¶ï¼Œå°±å¯ä»¥æŠŠ `v` åŠ å…¥é˜Ÿåˆ—ï¼Œå»æ›´æ–°å®ƒçš„ä¸Šæ¸¸åŸæ–™äº†ã€‚

è¿™ä¸ªè¿‡ç¨‹æœ¬è´¨ä¸Šå°±æ˜¯åå‘çš„æ‹“æ‰‘æ’åºï¼Œå–µ~

### 3. å¤„ç†ç²¾åº¦é—®é¢˜ï¼šçƒ¦äººçš„åˆ†æ•°ï¼

æ³¨æ„åˆ° `c_v / c_u` å¯èƒ½ä¼šäº§ç”Ÿåˆ†æ•°ï¼æ¯”å¦‚ `1 é“œ = 2 ç”µç¼†`ï¼Œé‚£ä¹ˆ1ä¸ªç”µç¼†å°±éœ€è¦ `1/2` ä¸ªé“œã€‚å¦‚æœä¸€è·¯ç®—ä¸‹å»ï¼Œä¼šæœ‰ä¸€å¤§å †åˆ†æ•°è¿ç®—ã€‚ç”¨ `double` æˆ– `float` è‚¯å®šä¼šå› ä¸ºç²¾åº¦é—®é¢˜è€Œå‡ºé”™ã€‚

æ€ä¹ˆåŠå‘¢ï¼Ÿæœ‰ä¸¤ä¸ªå¥½åŠæ³•ï¼š
1.  **åˆ†æ•°ç±»**: åƒ Python çš„ `fractions.Fraction` ä¸€æ ·ï¼Œè‡ªå·±å®ç°ä¸€ä¸ªåˆ†æ•°ç±»æ¥å¤„ç†è¿ç®—ã€‚
2.  **é«˜ç²¾åº¦æ•´æ•° (BigNum)**: è¿™æ˜¯ä¸€ä¸ªæ›´ç¨³å¦¥çš„åŠæ³•ã€‚æˆ‘ä»¬å¯ä»¥æŠŠæ‰€æœ‰æ•°éƒ½ä¹˜ä¸Šä¸€ä¸ªå·¨å¤§çš„å…¬åˆ†æ¯ï¼ŒæŠŠåˆ†æ•°è®¡ç®—å˜æˆæ•´æ•°è®¡ç®—ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¸è®¾ `demand[FP] = 1`ï¼Œè€Œæ˜¯è®¾ `demand[FP]` ä¸ºä¸€ä¸ªéå¸¸å¤§çš„æ•°ï¼Œæ¯”å¦‚ `2^N`ï¼ˆå› ä¸ºé…æ–¹ä¸­çš„ç³»æ•°éƒ½æ˜¯1æˆ–2ï¼Œåˆ†æ¯éƒ½æ˜¯2çš„å¹‚æ¬¡ï¼Œä¹˜ä¸Šä¸€ä¸ªå¤§çš„2çš„å¹‚æ¬¡å¯ä»¥ä¿è¯å¤§éƒ¨åˆ†æ—¶å€™æ˜¯æ•´æ•°ï¼‰ã€‚è¿™æ ·ï¼Œåœ¨è®¡ç®— `demand[u] * c_v / c_u` æ—¶ï¼Œæˆ‘ä»¬å°±åœ¨ç”¨é«˜ç²¾åº¦æ•´æ•°è¿›è¡Œè®¡ç®—ï¼Œå®Œç¾é¿å…äº†ç²¾åº¦æŸå¤±ï¼

ä»å‚è€ƒä»£ç æ¥çœ‹ï¼Œä½¿ç”¨é«˜ç²¾åº¦æ•´æ•°æ˜¯å¯è¡Œçš„ï¼Œæœ¬æˆ‘ä¹Ÿæ›´å–œæ¬¢è¿™ç§ä¸€åŠ›é™åä¼šçš„æš´åŠ›ç¾å­¦ï¼Œå–µå“ˆå“ˆï¼

### 4. æ‰¾åˆ°çœŸæ­£çš„ç“¶é¢ˆï¼

ç°åœ¨æˆ‘ä»¬æœ‰äº†æ¯ä¸ªç‰©å“ `i` çš„æ€»éœ€æ±‚é‡ `demand[i]`ã€‚æ¥ä¸‹æ¥å°±è¦ç»“åˆå·¥å‚é‡Œæ¯ç§ç‰©å“çš„æœºå™¨æ•°é‡ `a[i]` æ¥æ‰¾åˆ°ç“¶é¢ˆäº†ã€‚

*   **ä¾›åº”èƒ½åŠ›**: å‡è®¾ç”Ÿäº§ç‰©å“ `i` çš„é…æ–¹ä¸€æ¬¡èƒ½äº§å‡º `c_i` ä¸ªï¼Œè€Œæˆ‘ä»¬æœ‰ `a[i]` å°æœºå™¨ã€‚é‚£ä¹ˆç‰©å“ `i` çš„æœ€å¤§ä¾›åº”èƒ½åŠ›å°±æ˜¯ `a[i] * c_i`ã€‚ï¼ˆå¯¹äºè‡ªç„¶èµ„æºï¼Œ`c_i` å¯ä»¥çœ‹ä½œ1ï¼‰ã€‚
*   **éœ€æ±‚å‹åŠ›**: ä¸ºäº†ç”Ÿäº§1ä¸ªæœ€ç»ˆäº§å“ï¼Œæˆ‘ä»¬éœ€è¦ `demand[i]` ä¸ªç‰©å“ `i`ã€‚
*   **ç“¶é¢ˆå› å­**: æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªâ€œç“¶é¢ˆå› å­â€ `L[i] = demand[i] / (a[i] * c_i)`ã€‚è¿™ä¸ªå€¼ä»£è¡¨äº†â€œå•ä½ä¾›åº”èƒ½åŠ›éœ€è¦æ”¯æ’‘å¤šå°‘éœ€æ±‚â€ã€‚è¿™ä¸ªå€¼è¶Šå¤§ï¼Œè¯´æ˜è¿™ä¸ªç‰©å“çš„å‹åŠ›è¶Šå¤§ï¼Œè¶Šæ¥è¿‘ç“¶é¢ˆã€‚

æ‰€ä»¥ï¼Œ**ç”Ÿäº§ç“¶é¢ˆå°±æ˜¯é‚£äº›ç“¶é¢ˆå› å­ `L[i]` æœ€å¤§çš„ç‰©å“é›†åˆ**ã€‚

ä¸ºäº†æ¯”è¾ƒä¸¤ä¸ªç‰©å“ `i` å’Œ `j` çš„ç“¶é¢ˆå› å­å¤§å°ï¼Œå³æ¯”è¾ƒ `demand[i] / (a[i] * c_i)` å’Œ `demand[j] / (a[j] * c_j)`ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨**äº¤å‰ç›¸ä¹˜**æ¥é¿å…é«˜ç²¾åº¦æ•°çš„é™¤æ³•ï¼š
æ¯”è¾ƒ `demand[i] * a[j] * c_j` å’Œ `demand[j] * a[i] * c_i` çš„å¤§å°å³å¯ã€‚

### ç®—æ³•æ€»ç»“

å¥½å•¦ï¼Œæ¢³ç†ä¸€ä¸‹æˆ‘ä»¬çš„çˆªå°ğŸ¾ï¼š
1.  **æ•°æ®é¢„å¤„ç†**: è¯»å–è¾“å…¥ï¼Œç”¨ `std::map` æŠŠç‰©å“åå­—æ˜ å°„åˆ°æ•´æ•°IDã€‚å»ºç«‹`äº§å“ -> åŸæ–™`çš„å›¾ï¼Œå¹¶è®°å½•æ¯ä¸ªç‰©å“çš„`usage_count`ã€‚
2.  **è®¡ç®—éœ€æ±‚**:
    *   æ‰¾åˆ°æœ€ç»ˆäº§å“ `FP`ã€‚
    *   åˆå§‹åŒ– `demand[FP]` ä¸ºä¸€ä¸ªè¶³å¤Ÿå¤§çš„é«˜ç²¾åº¦æ•°ï¼ˆå¦‚ `2^N`ï¼‰ï¼Œå…¶ä½™ä¸º0ã€‚
    *   ä½¿ç”¨é˜Ÿåˆ—è¿›è¡Œåå‘æ‹“æ‰‘æ’åºï¼Œä» `FP` å¼€å§‹ï¼Œè®¡ç®—å‡ºæ‰€æœ‰ç‰©å“çš„ `demand[i]`ã€‚
3.  **å®šä½ç“¶é¢ˆ**:
    *   éå†æ‰€æœ‰ç‰©å“ï¼Œé€šè¿‡äº¤å‰ç›¸ä¹˜æ‰¾åˆ°å…·æœ‰æœ€å¤§â€œç“¶é¢ˆå› å­â€çš„ç‰©å“ã€‚
    *   å†æ¬¡éå†æ‰€æœ‰ç‰©å“ï¼ŒæŠŠæ‰€æœ‰ç“¶é¢ˆå› å­ä¸æœ€å¤§å€¼ç›¸ç­‰çš„ç‰©å“éƒ½æ‰¾å‡ºæ¥ã€‚
4.  **è¾“å‡ºç»“æœ**: å°†æ‰¾åˆ°çš„ç“¶é¢ˆç‰©å“çš„åå­—æŒ‰å­—å…¸åºæ’åºåè¾“å‡ºã€‚

è¿™æ ·ï¼Œé—®é¢˜å°±è§£å†³å•¦ï¼æ˜¯ä¸æ˜¯æ„Ÿè§‰æ¸…æ™°å¤šäº†å‘¢ï¼Ÿå–µ~

## ä»£ç å®ç°

è¿™æ˜¯æœ¬æˆ‘æ ¹æ®ä¸Šé¢çš„æ€è·¯ï¼Œé‡æ–°æ•´ç†çš„ä¸€ä»½æ¸…æ™°æ˜“æ‡‚çš„ä»£ç å“¦~ é™„ä¸Šäº†è¯¦ç»†çš„æ³¨é‡Šï¼Œå¸Œæœ›èƒ½å¸®åˆ°ä½ ï¼

```cpp
#include <iostream>
#include <vector>
#include <string>
#include <map>
#include <queue>
#include <algorithm>

// --- Start of BigNum Class ---
// ä¸€ä¸ªç®€åŒ–ç‰ˆçš„é«˜ç²¾åº¦æ•´æ•°ç±»ï¼ŒåªåŒ…å«æœ¬é¢˜éœ€è¦çš„æ“ä½œ
// ä¸ºäº†ç®€æ´ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨ vector<int> å¹¶é‡‡ç”¨ä¸‡è¿›åˆ¶
struct BigNum {
    std::vector<int> digits;
    static const int BASE = 10000;

    BigNum(long long n = 0) {
        if (n == 0) {
            digits.push_back(0);
        }
        while (n > 0) {
            digits.push_back(n % BASE);
            n /= BASE;
        }
    }

    BigNum operator+(const BigNum& other) const {
        BigNum result;
        result.digits.clear();
        int carry = 0;
        for (size_t i = 0; i < digits.size() || i < other.digits.size() || carry; ++i) {
            int current = carry;
            if (i < digits.size()) current += digits[i];
            if (i < other.digits.size()) current += other.digits[i];
            result.digits.push_back(current % BASE);
            carry = current / BASE;
        }
        return result;
    }

    BigNum operator*(int n) const {
        BigNum result;
        result.digits.clear();
        long long carry = 0;
        for (size_t i = 0; i < digits.size() || carry; ++i) {
            long long current = carry;
            if (i < digits.size()) current += (long long)digits[i] * n;
            result.digits.push_back(current % BASE);
            carry = current / BASE;
        }
        while (result.digits.size() > 1 && result.digits.back() == 0) {
            result.digits.pop_back();
        }
        return result;
    }

    BigNum operator/(int n) const {
        BigNum result;
        result.digits.resize(digits.size());
        long long remainder = 0;
        for (int i = digits.size() - 1; i >= 0; --i) {
            remainder = remainder * BASE + digits[i];
            result.digits[i] = remainder / n;
            remainder %= n;
        }
        while (result.digits.size() > 1 && result.digits.back() == 0) {
            result.digits.pop_back();
        }
        return result;
    }

    // æ¯”è¾ƒå‡½æ•°: a > b è¿”å› 1, a < b è¿”å› -1, a == b è¿”å› 0
    int compare(const BigNum& other) const {
        if (digits.size() != other.digits.size()) {
            return digits.size() > other.digits.size() ? 1 : -1;
        }
        for (int i = digits.size() - 1; i >= 0; --i) {
            if (digits[i] != other.digits[i]) {
                return digits[i] > other.digits[i] ? 1 : -1;
            }
        }
        return 0;
    }
};
// --- End of BigNum Class ---

struct Material {
    int id;
    int count;
};

int main() {
    std::ios_base::sync_with_stdio(false);
    std::cin.tie(NULL);

    int n, m;
    while (std::cin >> n >> m) {
        std::map<std::string, int> name_to_id;
        std::vector<std::string> id_to_name(n);
        std::vector<int> machine_count(n);
        
        for (int i = 0; i < n; ++i) {
            std::cin >> id_to_name[i] >> machine_count[i];
            name_to_id[id_to_name[i]] = i;
        }

        std::vector<std::vector<Material>> recipes(n);
        std::vector<int> product_yield(n, 1); // é»˜è®¤ä¸º1ï¼Œå¯¹è‡ªç„¶èµ„æºä¹Ÿé€‚ç”¨
        std::vector<int> usage_count(n, 0); // ç‰©å“ä½œä¸ºåŸæ–™è¢«ä½¿ç”¨çš„æ¬¡æ•°

        for (int i = 0; i < m; ++i) {
            std::vector<Material> current_materials;
            int count;
            std::string name;
            char op;

            while (std::cin >> count >> name) {
                current_materials.push_back({name_to_id[name], count});
                std::cin >> op;
                if (op == '=') break;
            }
            
            int product_id = current_materials.back().id;
            int product_count = current_materials.back().count;
            current_materials.pop_back();

            recipes[product_id] = current_materials;
            product_yield[product_id] = product_count;

            for (const auto& mat : current_materials) {
                usage_count[mat.id]++;
            }
        }

        // 2. è®¡ç®—éœ€æ±‚
        int final_product_id = -1;
        for (int i = 0; i < n; ++i) {
            if (usage_count[i] == 0) {
                final_product_id = i;
                break;
            }
        }

        std::vector<BigNum> demand(n, BigNum(0));
        // è®¾ç½®ä¸€ä¸ªè¶³å¤Ÿå¤§çš„åˆå§‹å€¼ä»¥é¿å…åˆ†æ•°
        BigNum base_val(1);
        for(int i = 0; i < n; ++i) base_val = base_val * 2;
        demand[final_product_id] = base_val;

        std::queue<int> q;
        q.push(final_product_id);

        while (!q.empty()) {
            int u = q.front();
            q.pop();

            for (const auto& material : recipes[u]) {
                int v = material.id;
                int material_c = material.count;
                int product_c = product_yield[u];
                
                demand[v] = demand[v] + (demand[u] * material_c / product_c);
                
                usage_count[v]--;
                if (usage_count[v] == 0) {
                    q.push(v);
                }
            }
        }

        // 3. å®šä½ç“¶é¢ˆ
        std::vector<int> bottleneck_candidates;
        int max_bottleneck_id = 0;

        for (int i = 1; i < n; ++i) {
            // æ¯”è¾ƒ i å’Œ max_bottleneck_id è°æ›´æ˜¯ç“¶é¢ˆ
            // æ¯”è¾ƒ demand[i] / (a[i]*c[i]) å’Œ demand[j] / (a[j]*c[j])
            // ç­‰ä»·äºæ¯”è¾ƒ demand[i] * a[j]*c[j] å’Œ demand[j] * a[i]*c[i]
            BigNum val_i = demand[i] * machine_count[max_bottleneck_id] * product_yield[max_bottleneck_id];
            BigNum val_j = demand[max_bottleneck_id] * machine_count[i] * product_yield[i];
            
            if (val_i.compare(val_j) > 0) {
                max_bottleneck_id = i;
            }
        }

        for (int i = 0; i < n; ++i) {
            BigNum val_i = demand[i] * machine_count[max_bottleneck_id] * product_yield[max_bottleneck_id];
            BigNum val_j = demand[max_bottleneck_id] * machine_count[i] * product_yield[i];
            if (val_i.compare(val_j) == 0) {
                bottleneck_candidates.push_back(i);
            }
        }

        // 4. è¾“å‡ºç»“æœ
        std::vector<std::string> result_names;
        for (int id : bottleneck_candidates) {
            result_names.push_back(id_to_name[id]);
        }
        std::sort(result_names.begin(), result_names.end());
        
        std::cout << result_names.size() << "\n";
        for (size_t i = 0; i < result_names.size(); ++i) {
            std::cout << result_names[i] << (i == result_names.size() - 1 ? "" : " ");
        }
        std::cout << "\n";
    }
    return 0;
}
```

## å¤æ‚åº¦åˆ†æ

*   **æ—¶é—´å¤æ‚åº¦**: $O((N+M_{total}) \cdot L)$
    *   $N$ æ˜¯ç‰©å“ç§ç±»æ•°ï¼Œ $M$ æ˜¯é…æ–¹æ•°ã€‚è®¾ $M_{total}$ æ˜¯æ‰€æœ‰é…æ–¹ä¸­åŸæ–™é¡¹çš„æ€»æ•°ã€‚
    *   é¢„å¤„ç†ï¼ˆå»ºå›¾ç­‰ï¼‰çš„æ—¶é—´æ˜¯ $O(N + M_{total})$ã€‚
    *   è®¡ç®— `demand` çš„æ‹“æ‰‘æ’åºè¿‡ç¨‹ï¼Œæ¯ä¸ªèŠ‚ç‚¹å’Œæ¯æ¡è¾¹ï¼ˆä¾èµ–å…³ç³»ï¼‰è¢«è®¿é—®ä¸€æ¬¡ã€‚æ¯æ¬¡è®¿é—®æ¶‰åŠé«˜ç²¾åº¦æ•°çš„åŠ æ³•ã€ä¹˜æ³•å’Œé™¤æ³•ã€‚è®¾é«˜ç²¾åº¦æ•°çš„å¹³å‡é•¿åº¦ä¸º $L$ï¼Œè¿™äº›æ“ä½œçš„å¤æ‚åº¦æ˜¯ $O(L)$ã€‚æ‰€ä»¥è¿™éƒ¨åˆ†çš„å¤æ‚åº¦æ˜¯ $O((N+M_{total}) \cdot L)$ã€‚
    *   å¯»æ‰¾ç“¶é¢ˆéœ€è¦ $O(N)$ æ¬¡æ¯”è¾ƒï¼Œæ¯æ¬¡æ¯”è¾ƒæ˜¯ä¸¤æ¬¡é«˜ç²¾åº¦ä¹˜æ³•ï¼Œå¤æ‚åº¦æ˜¯ $O(L)$ã€‚æ‰€ä»¥è¿™éƒ¨åˆ†æ˜¯ $O(N \cdot L)$ã€‚
    *   é«˜ç²¾åº¦æ•°çš„é•¿åº¦ $L$ æœ€åæƒ…å†µä¸‹å’Œ $N$ ç›¸å…³ï¼Œå› ä¸ºè·¯å¾„æœ€é•¿ä¸º $N$ï¼Œæ¯æ¬¡ä¹˜2æˆ–é™¤2ï¼Œé•¿åº¦ä¼šå¢é•¿ã€‚æ‰€ä»¥ $L$ å¯ä»¥çœ‹ä½œ $O(N)$ã€‚
    *   ç»¼åˆæ¥çœ‹ï¼Œæ€»æ—¶é—´å¤æ‚åº¦ä¸»è¦ç”±è®¡ç®— `demand` çš„è¿‡ç¨‹å†³å®šï¼Œçº¦ä¸º $O((N+M_{total}) \cdot L)$ã€‚

*   **ç©ºé—´å¤æ‚åº¦**: $O(N \cdot L + M_{total})$
    *   å­˜å‚¨å›¾ã€é…æ–¹ç­‰ä¿¡æ¯éœ€è¦ $O(N + M_{total})$ çš„ç©ºé—´ã€‚
    *   `demand` æ•°ç»„å­˜å‚¨äº† $N$ ä¸ªé«˜ç²¾åº¦æ•°ï¼Œæ¯ä¸ªé•¿åº¦ä¸º $L$ï¼Œæ‰€ä»¥éœ€è¦ $O(N \cdot L)$ çš„ç©ºé—´ã€‚
    *   å› æ­¤ï¼Œæ€»ç©ºé—´å¤æ‚åº¦ä¸º $O(N \cdot L + M_{total})$ã€‚

## çŸ¥è¯†ç‚¹æ€»ç»“

è¿™é“é¢˜çœŸæ˜¯ä¸€æ¬¡æœ‰è¶£çš„å·¥å‚å†’é™©ï¼Œå–µ~ ä»ä¸­æˆ‘ä»¬å¯ä»¥å­¦åˆ°ï¼š
1.  **å›¾è®ºå»ºæ¨¡**: å°†å¤æ‚çš„ç”Ÿäº§å…³ç³»æŠ½è±¡ä¸ºæœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰æ˜¯è§£å†³é—®é¢˜çš„å…³é”®ç¬¬ä¸€æ­¥ã€‚
2.  **æ‹“æ‰‘æ’åº**: å¯¹äºDAGä¸Šçš„ä¾èµ–è®¡ç®—é—®é¢˜ï¼Œæ‹“æ‰‘æ’åºï¼ˆæˆ–å…¶å˜ä½“ï¼Œå¦‚æœ¬é¢˜ä¸­çš„åå‘è®¡ç®—ï¼‰æ˜¯éå¸¸æœ‰æ•ˆçš„å·¥å…·ã€‚
3.  **é«˜ç²¾åº¦è®¡ç®—**: å½“é‡åˆ°ä¼šäº§ç”Ÿåˆ†æ•°çš„è®¡ç®—ä¸”ç²¾åº¦è¦æ±‚é«˜æ—¶ï¼Œè¦æœæ–­ä½¿ç”¨é«˜ç²¾åº¦æ•´æ•°ï¼ˆBigNumï¼‰æˆ–åˆ†æ•°ç±»æ¥é¿å…`double`å¸¦æ¥çš„è¯¯å·®ã€‚
4.  **äº¤å‰ç›¸ä¹˜**: è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒä¸¤ä¸ªåˆ†æ•°å¤§å°çš„å¸¸ç”¨æŠ€å·§ï¼Œå¯ä»¥é¿å…é«˜ç²¾åº¦æ•°ä¹‹é—´éš¾ä»¥å®ç°çš„é™¤æ³•è¿ç®—ã€‚
5.  **é—®é¢˜åˆ†è§£**: é¢å¯¹ä¸€ä¸ªå¤æ‚çš„é—®é¢˜æè¿°ï¼Œä¸è¦æ…Œå¼ ï¼ŒæŠŠå®ƒæ‹†è§£æˆæ•°æ®ç»“æ„å»ºç«‹ã€æ ¸å¿ƒé€»è¾‘è®¡ç®—ã€ç»“æœæŸ¥æ‰¾ç­‰å‡ ä¸ªå°æ­¥éª¤ï¼Œé€ä¸€æ”»å…‹ï¼Œå°±èƒ½æ‰¾åˆ°é€šå¾€ACçš„é“è·¯å•¦ï¼

å¸Œæœ›è¿™ç¯‡é¢˜è§£èƒ½è®©ä½ æœ‰æ‰€æ”¶è·ï¼Œå–µ~ ä¸‹æ¬¡å†ä¸€èµ·æ¢é™©å§ï¼