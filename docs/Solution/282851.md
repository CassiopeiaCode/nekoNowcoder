# å²›å±¿é¢˜ - é¢˜è§£

### æ ‡ç­¾ä¸éš¾åº¦
> **æ ‡ç­¾**: Kruskalé‡æ„æ ‘, å¯æ’¤é”€å¹¶æŸ¥é›†, ç¦»çº¿ç®—æ³•, å›¾è®º, æœ€å¤§ç“¶é¢ˆè·¯, æœ€å°å‰², å¹¿åº¦ä¼˜å…ˆæœç´¢, BFS
> **éš¾åº¦**: 2900

## é¢˜ç›®å¤§æ„å–µ~

ä¸»äººä½ å¥½å–µ~ è¿™æ˜¯ä¸€é“æœ‰ç‚¹å¤æ‚çš„å›¾è®ºé¢˜å“¦ï¼Œè®©æœ¬å–µæ¥ç»™ä½ æ¢³ç†ä¸€ä¸‹å§ï¼

æˆ‘ä»¬æ‹¿åˆ°äº†ä¸€å¼  $N \times M$ çš„åœ°å›¾ï¼Œä¸Šé¢æœ‰ä¸‰ç§åœ°å½¢ï¼š
*   `#`: å²›å±¿ï¼Œæˆ‘ä»¬ä¸èƒ½èµ°ä¸Šå»ã€‚
*   `.`: ç©ºåœ°ï¼Œå¯ä»¥è‡ªç”±è¡Œèµ°ã€‚
*   `v`: ç«å±±ï¼Œä¹Ÿå¯ä»¥èµ°ä¸Šå»ã€‚

æ¥ä¸‹æ¥ä¼šæœ‰ $Q$ æ¬¡è¯¢é—®ï¼Œæ¯æ¬¡éƒ½ç»™ä¸€ä¸ªèµ·ç‚¹ `(r, c)`ã€‚å¯¹äºæ¯æ¬¡è¯¢é—®ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€æ¡ä» `(r, c)` å‡ºå‘ã€æœ€ååˆå›åˆ° `(r, c)` çš„è·¯å¾„ï¼Œè¿™æ¡è·¯å¾„éœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š
1.  **åˆæ³•æ€§**: è·¯å¾„ä¸Šçš„æ¯ä¸€æ­¥éƒ½åªèƒ½åœ¨åœ°å›¾å†…ï¼Œå¹¶ä¸”ä¸èƒ½ç»è¿‡å²›å±¿ `#`ã€‚æ³¨æ„ï¼Œæˆ‘ä»¬å¯ä»¥é‡å¤èµ°è¿‡ä¸€ä¸ªç‚¹æˆ–è€…ä¸€æ¡è¾¹å“¦ã€‚
2.  **åŒ…å›´æ€§**: è¿™æ¡è·¯å¾„å¿…é¡»æŠŠ**æ‰€æœ‰**çš„å²›å±¿éƒ½â€œå›´èµ·æ¥â€ã€‚å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯å¦‚æœæˆ‘ä»¬æŠŠè·¯å¾„ä¸Šç»è¿‡çš„æ‰€æœ‰ç‚¹éƒ½ä»åœ°å›¾ä¸Šâ€œåˆ é™¤â€ï¼Œé‚£ä¹ˆä»»ä½•ä¸€ä¸ªå²›å±¿æ ¼å­éƒ½ä¸èƒ½é€šè¿‡å…«ä¸ªæ–¹å‘ï¼ˆä¸Šã€ä¸‹ã€å·¦ã€å³ã€å·¦ä¸Šã€å·¦ä¸‹ã€å³ä¸Šã€å³ä¸‹ï¼‰è¿æ¥åˆ°åœ°å›¾çš„è¾¹ç•Œã€‚

å¯¹äºè¿™æ ·ä¸€æ¡â€œåŒ…å›´è·¯å¾„â€ï¼Œæˆ‘ä»¬å®šä¹‰å®ƒçš„**æƒå€¼**ä¸ºï¼šè·¯å¾„ä¸Šæ‰€æœ‰ç‚¹çš„â€œç‚¹æƒâ€çš„**æœ€å°å€¼**ã€‚è€Œä¸€ä¸ªç‚¹çš„â€œç‚¹æƒâ€è¢«å®šä¹‰ä¸ºå®ƒåˆ°æœ€è¿‘çš„ç«å±±çš„**æ›¼å“ˆé¡¿è·ç¦»**ã€‚

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ï¼Œå¯¹äºæ¯ä¸ªç»™å®šçš„èµ·ç‚¹ `(r, c)`ï¼Œæ‰¾åˆ°ä¸€æ¡æ»¡è¶³æ¡ä»¶çš„åŒ…å›´è·¯å¾„ï¼Œä½¿å¾—å®ƒçš„è·¯å¾„æƒå€¼**æœ€å¤§**ï¼ç„¶åè¾“å‡ºè¿™ä¸ªæœ€å¤§çš„æƒå€¼ã€‚

å¬èµ·æ¥æ˜¯ä¸æ˜¯æœ‰ç‚¹ç»•ï¼Ÿæ²¡å…³ç³»ï¼Œè·Ÿç€æœ¬å–µçš„æ€è·¯ä¸€æ­¥æ­¥æ¥ï¼Œå¾ˆå¿«å°±èƒ½æå®šå•¦ï¼Œå–µ~

## è§£é¢˜æ€è·¯åˆ†æ

è¿™é“é¢˜çš„æ ¸å¿ƒæ˜¯â€œæœ€å¤§åŒ–æœ€å°å€¼â€ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„ä¿¡å·ï¼Œé€šå¸¸æŒ‡å‘äºŒåˆ†ç­”æ¡ˆæˆ–è€…åƒæœ¬é¢˜è§£æ³•ä¸­ç”¨åˆ°çš„ Kruskal é‡æ„æ ‘~ã€‚è®©æˆ‘ä»¬æ¥ä¸€æ­¥æ­¥æ‹†è§£è¿™ä¸ªé—®é¢˜å§ï¼

#### ç¬¬ä¸€æ­¥ï¼šç‚¹æƒé¢„å¤„ç†

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“åœ°å›¾ä¸Šæ¯ä¸ªæ ¼å­çš„ç‚¹æƒï¼Œä¹Ÿå°±æ˜¯å®ƒåˆ°æœ€è¿‘ç«å±±çš„æ›¼å“ˆé¡¿è·ç¦»ã€‚è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„å¤šæºæœ€çŸ­è·¯é—®é¢˜ã€‚å› ä¸ºç½‘æ ¼å›¾ä¸Šçš„è¾¹æƒéƒ½æ˜¯1ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ä¸€æ¬¡**å¤šæºå¹¿åº¦ä¼˜å…ˆæœç´¢ï¼ˆMulti-source BFSï¼‰** æ¥è§£å†³ã€‚

å…·ä½“åšæ³•æ˜¯ï¼š
1.  åˆ›å»ºä¸€ä¸ª `dist[N][M]` æ•°ç»„ï¼Œåˆå§‹åŒ–ä¸ºæ— ç©·å¤§ã€‚
2.  å°†æ‰€æœ‰ç«å±± `v` çš„ä½ç½®æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œå¹¶å°†å®ƒä»¬çš„ `dist` å€¼è®¾ä¸º 0ã€‚
3.  åƒæ™®é€š BFS ä¸€æ ·ï¼Œä¸æ–­ä»é˜Ÿåˆ—ä¸­å–å‡ºç‚¹ï¼Œå¹¶å‘å…¶å››æ–¹å‘çš„é‚»å±…æ‰©å±•ï¼Œæ›´æ–°å®ƒä»¬çš„ `dist` å€¼ã€‚

è¿™æ ·ï¼ŒBFS ç»“æŸåï¼Œ`dist[i][j]` å°±å­˜å‚¨äº†ç‚¹ `(i, j)` åˆ°æœ€è¿‘ç«å±±çš„æ›¼å“ˆtonè·ç¦»å•¦ï¼Œè¿™å°±æ˜¯å®ƒçš„ç‚¹æƒï¼æˆ‘ä»¬ä¹‹åç§°ä¹‹ä¸º `val(u)`ã€‚

#### ç¬¬äºŒæ­¥ï¼šç†è§£â€œåŒ…å›´â€çš„çœŸæ­£å«ä¹‰

â€œåŒ…å›´â€è¿™ä¸ªè¯å¬èµ·æ¥å¾ˆå½¢è±¡ï¼Œä½†åœ¨ç®—æ³•é‡Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ›´ç²¾ç¡®çš„å®šä¹‰ã€‚é¢˜ç›®è¯´ï¼Œç§»é™¤è·¯å¾„ä¸Šçš„ç‚¹åï¼Œå²›å±¿å’Œè¾¹ç•Œå°±åˆ†å¼€äº†ã€‚è¿™å…¶å®æ˜¯åœ¨æè¿°ä¸€ä¸ª**å‰²**ï¼ˆCutï¼‰çš„æ¦‚å¿µã€‚

æˆ‘ä»¬å¯ä»¥æŠŠé—®é¢˜æ¨¡å‹åŒ–ï¼š
1.  å»ºç«‹ä¸€ä¸ªåŒ…å«æ‰€æœ‰æ ¼å­çš„å…«è¿é€šå›¾ï¼ˆå› ä¸ºè¿é€šæ€§æ˜¯å…«æ–¹å‘çš„ï¼‰ã€‚
2.  è®¾ç½®ä¸€ä¸ªè¶…çº§æºç‚¹ `S`ï¼Œå°†å®ƒä¸æ‰€æœ‰è¾¹ç•Œæ ¼å­ç›¸è¿ã€‚
3.  è®¾ç½®ä¸€ä¸ªè¶…çº§æ±‡ç‚¹ `T`ï¼Œå°†å®ƒä¸æ‰€æœ‰å²›å±¿ `#` æ ¼å­ç›¸è¿ã€‚

ç°åœ¨ï¼Œâ€œåŒ…å›´æ‰€æœ‰å²›å±¿â€å°±ç­‰ä»·äºï¼šæ‰¾åˆ°ä¸€ä¸ª**ç‚¹é›†**ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„è·¯å¾„ï¼‰ï¼Œä»å›¾ä¸­ç§»é™¤è¿™ä¸ªç‚¹é›†åï¼Œ`S` å’Œ `T` ä¸å†è¿é€šã€‚è¿™æ ·çš„ç‚¹é›†è¢«ç§°ä¸º **S-T ç‚¹å‰²**ã€‚

æˆ‘ä»¬çš„è·¯å¾„å¿…é¡»æ˜¯ä¸€ä¸ª S-T ç‚¹å‰²ï¼Œå¹¶ä¸”è¦åŒ…å«ç»™å®šçš„èµ·ç‚¹ `(r, c)`ã€‚

#### ç¬¬ä¸‰æ­¥ï¼šä»â€œæœ€å¤§åŒ–æœ€å°å€¼â€åˆ° Kruskal é‡æ„æ ‘

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯æœ€å¤§åŒ–è·¯å¾„çš„æƒå€¼ï¼Œä¹Ÿå°±æ˜¯ `max(min(val(u)))` for `u` in pathã€‚

å‡è®¾æˆ‘ä»¬æƒ³çŸ¥é“ï¼Œæ˜¯å¦å­˜åœ¨ä¸€æ¡æƒå€¼è‡³å°‘ä¸º `W` çš„åŒ…å›´è·¯å¾„ã€‚è¿™æ„å‘³ç€ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€æ¡åŒ…å›´è·¯å¾„ï¼Œå®ƒä¸Šé¢çš„æ‰€æœ‰ç‚¹çš„ç‚¹æƒ `val(u)` éƒ½å¿…é¡»å¤§äºç­‰äº `W`ã€‚

è¿™å¯å‘æˆ‘ä»¬ï¼Œå¯ä»¥åªä½¿ç”¨é‚£äº›ç‚¹æƒ `val(u) >= W` çš„ç‚¹æ¥æ„å»ºæˆ‘ä»¬çš„è·¯å¾„ã€‚ä¸€æ¡åŒ…å›´è·¯å¾„ï¼ˆS-T ç‚¹å‰²ï¼‰å­˜åœ¨ï¼Œå½“ä¸”ä»…å½“åœ¨ä½¿ç”¨è¿™äº› `val(u) >= W` çš„ç‚¹æ„æˆçš„å›¾ä¸­ï¼Œ`S` å’Œ `T` æ˜¯è¿é€šçš„ã€‚ï¼ˆå¦‚æœ `S` å’Œ `T` åœ¨è¿™ä¸ªå­å›¾ä¸­æ–­å¼€ï¼Œé‚£å®ƒä»¬æœ¬æ¥å°±æ˜¯åˆ†å¼€çš„ï¼Œä¸éœ€è¦æˆ‘ä»¬å»å‰²ï¼›å¦‚æœè¿é€šï¼Œæˆ‘ä»¬æ€»èƒ½æ‰¾åˆ°ä¸€ä¸ªå‰²ï¼‰ã€‚

æ‰€ä»¥é—®é¢˜è½¬åŒ–ä¸ºï¼šå¯¹äºä¸€ä¸ªæŸ¥è¯¢ç‚¹ `u`ï¼Œæ‰¾åˆ°æœ€å¤§çš„ `W`ï¼Œæ»¡è¶³ï¼š
1.  `val(u) >= W` ï¼ˆå› ä¸º `u` å¿…é¡»åœ¨è·¯å¾„ä¸Šï¼‰ã€‚
2.  åœ¨ç”±æ‰€æœ‰ç‚¹æƒä¸å°äº `W` çš„éå²›å±¿ç‚¹æ„æˆçš„å…«è¿é€šå›¾ä¸­ï¼Œ`S` å’Œ `T` æ˜¯è¿é€šçš„ã€‚

è¦å¯¹æ¯ä¸ª `W` éƒ½æ£€æŸ¥ä¸€æ¬¡å¤ªæ…¢äº†ã€‚è¿™æ—¶å€™ï¼Œ**Kruskal é‡æ„æ ‘** å°±é—ªäº®ç™»åœºå•¦ï¼Œå–µï¼å®ƒå¯ä»¥ä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰ `W` çš„æƒ…å†µã€‚

æˆ‘ä»¬ä¸ç›´æ¥åœ¨å…«è¿é€šå›¾ä¸Šå»ºæ ‘ï¼Œè€Œæ˜¯åœ¨**å››è¿é€š**çš„éå²›å±¿ç‚¹å›¾ä¸Šå»ºç«‹ã€‚è¿™æ˜¯å› ä¸ºè·¯å¾„æœ¬èº«æ˜¯å››è¿é€šçš„ã€‚
1.  å°†æ‰€æœ‰éå²›å±¿ç‚¹ï¼ŒæŒ‰ç…§å®ƒä»¬çš„ç‚¹æƒ `val` ä»å¤§åˆ°å°æ’åºã€‚
2.  åˆå§‹åŒ–ä¸€ä¸ªå¹¶æŸ¥é›†ï¼Œæ¯ä¸ªç‚¹è‡ªæˆä¸€ä¸ªé›†åˆã€‚
3.  æŒ‰é¡ºåºå¤„ç†æ’åºåçš„ç‚¹ `u`ã€‚å¯¹äº `u` çš„æ¯ä¸ªå·²ç»è¢«å¤„ç†è¿‡çš„å››è¿é€šé‚»å±… `v`ï¼Œå¦‚æœ `u` å’Œ `v` ä¸åœ¨åŒä¸€ä¸ªé›†åˆä¸­ï¼Œå°±åœ¨é‡æ„æ ‘ä¸­ï¼Œå°† `v` æ‰€åœ¨é›†åˆçš„æ ¹èŠ‚ç‚¹ä½œä¸º `u` çš„å­èŠ‚ç‚¹ï¼Œç„¶ååˆå¹¶è¿™ä¸¤ä¸ªé›†åˆã€‚`u` çš„æƒå€¼å°±æ˜¯ `val(u)`ã€‚

è¿™æ ·å»ºå‡ºçš„æ ‘ï¼ˆæ£®æ—ï¼‰å°±æ˜¯ Kruskal é‡æ„æ ‘ã€‚å®ƒæœ‰éå¸¸æ£’çš„æ€§è´¨ï¼š
*   å®ƒæ˜¯ä¸€æ£µå †æœ‰åºçš„æ ‘ï¼šçˆ¶èŠ‚ç‚¹çš„ `val` å°äºç­‰äºå­èŠ‚ç‚¹çš„ `val`ã€‚
*   æ ‘ä¸Šä»»æ„ä¸¤ç‚¹ `a`, `b` çš„æœ€è¿‘å…¬å…±ç¥–å…ˆï¼ˆLCAï¼‰çš„ `val`ï¼Œå°±æ˜¯åŸå›¾ä¸­ `a` åˆ° `b` æ‰€æœ‰è·¯å¾„ä¸­ï¼Œè·¯å¾„ä¸Šç‚¹æƒæœ€å°å€¼çš„æœ€å¤§å€¼ï¼ˆå³æœ€å¤§ç“¶é¢ˆè·¯ï¼‰ã€‚
*   ä¸€ä¸ªèŠ‚ç‚¹ `p` çš„å­æ ‘ä¸­çš„æ‰€æœ‰å¶å­èŠ‚ç‚¹ï¼Œæ„æˆäº†ä¸€ä¸ªè¿é€šå—ï¼Œå…¶ä¸­ä»»æ„ä¸¤ç‚¹éƒ½å¯ä»¥é€šè¿‡ç‚¹æƒä¸å°äº `val(p)` çš„è·¯å¾„äº’ç›¸åˆ°è¾¾ã€‚

#### ç¬¬å››æ­¥ï¼šç¦»çº¿æŸ¥è¯¢ä¸å¯æ’¤é”€å¹¶æŸ¥é›†

æœ‰äº†é‡æ„æ ‘ï¼Œé—®é¢˜å°±å˜æˆäº†ï¼šå¯¹äºæ¯ä¸ªæŸ¥è¯¢ç‚¹ `u`ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°å®ƒ**æ·±åº¦æœ€æµ…**ï¼ˆ`val` æœ€å°ï¼‰çš„ç¥–å…ˆ `p`ï¼Œä½¿å¾— `p` çš„å­æ ‘æ‰€ä»£è¡¨çš„ç‚¹é›†ï¼Œèƒ½å¤Ÿåœ¨å…«è¿é€šå›¾ä¸­è¿é€š `S` å’Œ `T`ã€‚è¿™ä¸ª `val(p)` å°±æ˜¯ç­”æ¡ˆã€‚

ä¸ºä»€ä¹ˆæ˜¯æ·±åº¦æœ€æµ…çš„ç¥–å…ˆå‘¢ï¼Ÿå› ä¸ºç¥–å…ˆè¶Šæµ…ï¼Œ`val` è¶Šå°ï¼Œä½†å…¶å­æ ‘åŒ…å«çš„ç‚¹è¶Šå¤šï¼Œè¶Šæœ‰å¯èƒ½è¿é€š `S` å’Œ `T`ã€‚æˆ‘ä»¬è¦æ‰¾çš„æ˜¯æ°å¥½èƒ½æ»¡è¶³è¿é€šæ€§çš„é‚£ä¸ªä¸´ç•Œç‚¹ï¼Œä»¥å¾—åˆ°æœ€å¤§çš„ `W`ã€‚

è¿™å¼•å‡ºäº†æœ€ç»ˆçš„æ ¸å¿ƒé—®é¢˜ï¼šå¯¹é‡æ„æ ‘ä¸­çš„**æ¯ä¸ªèŠ‚ç‚¹** `p`ï¼Œåˆ¤æ–­å…¶å­æ ‘ä¸­çš„æ‰€æœ‰ç‚¹ï¼Œèƒ½å¦åœ¨å…«è¿é€šå›¾ä¸­è¿é€š `S` å’Œ `T`ã€‚

è¿™æ˜¯ä¸€ä¸ªç»å…¸çš„**ç¦»çº¿**é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€æ¬¡å¯¹é‡æ„æ ‘çš„ DFS æ¥è§£å†³æ‰€æœ‰èŠ‚ç‚¹çš„æŸ¥è¯¢ã€‚ä¸ºäº†åœ¨ DFS çš„è¿‡ç¨‹ä¸­åŠ¨æ€ç»´æŠ¤å›¾çš„è¿é€šæ€§ï¼ˆæ·»åŠ èŠ‚ç‚¹ã€é€’å½’ã€å†ç§»é™¤èŠ‚ç‚¹ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨**å¯æ’¤é”€å¹¶æŸ¥é›†ï¼ˆDSU with Rollbackï¼‰**ã€‚

ç®—æ³•æµç¨‹å¦‚ä¸‹ï¼š
1.  åœ¨é‡æ„æ ‘ä¸Šè¿›è¡Œä¸€æ¬¡ DFSï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º `solve(p)`ã€‚
2.  è¿›å…¥ `solve(p)` æ—¶ï¼Œè®°å½•å½“å‰å¯æ’¤é”€å¹¶æŸ¥é›†çš„çŠ¶æ€ã€‚
3.  å°†èŠ‚ç‚¹ `p` è‡ªå·±æ‰€ä»£è¡¨çš„é‚£ä¸ªåŸå§‹ç‚¹åŠ å…¥åˆ°å…«è¿é€šå›¾ä¸­ã€‚å…·ä½“æ“ä½œæ˜¯ï¼Œæ£€æŸ¥å®ƒçš„å…«ä¸ªé‚»å±…ï¼Œå¦‚æœé‚»å±…æ˜¯è¾¹ç•Œï¼Œå°±ä¸ `S` åˆå¹¶ï¼›å¦‚æœæ˜¯å²›å±¿ï¼Œå°±ä¸ `T` åˆå¹¶ï¼›å¦‚æœæ˜¯å…¶ä»–å·²åœ¨å›¾ä¸­ï¼ˆå³ `p` çš„ç¥–å…ˆï¼‰çš„éå²›å±¿ç‚¹ï¼Œå°±ä¸é‚£ä¸ªç‚¹åˆå¹¶ã€‚æ‰€æœ‰åˆå¹¶æ“ä½œéƒ½è®°å½•ä¸‹æ¥ã€‚
4.  åœ¨å½“å‰çŠ¶æ€ä¸‹ï¼Œæ£€æŸ¥ `S` å’Œ `T` æ˜¯å¦è¿é€šã€‚å¦‚æœè¿é€šï¼Œæˆ‘ä»¬å°±è®°å½•ä¸‹æ¥ï¼š`p` æ˜¯ä¸€ä¸ªâ€œæœ‰æ•ˆçš„â€åŒ…å›´ç‚¹é›†æä¾›è€…ã€‚
5.  å¯¹ `p` çš„æ‰€æœ‰å­©å­ `c`ï¼Œé€’å½’è°ƒç”¨ `solve(c)`ã€‚
6.  ä»æ‰€æœ‰é€’å½’è°ƒç”¨è¿”å›åï¼Œæ’¤é”€åœ¨ç¬¬ 3 æ­¥ä¸­å¯¹å¹¶æŸ¥é›†æ‰€åšçš„æ‰€æœ‰ä¿®æ”¹ï¼Œæ¢å¤åˆ°è¿›å…¥ `solve(p)` æ—¶çš„çŠ¶æ€ã€‚

å®Œæˆè¿™æ¬¡ DFS åï¼Œæˆ‘ä»¬å°±çŸ¥é“äº†æ¯ä¸ªèŠ‚ç‚¹ `p` æ˜¯å¦â€œæœ‰æ•ˆâ€ã€‚

#### ç¬¬äº”æ­¥ï¼šå¾—åˆ°æœ€ç»ˆç­”æ¡ˆ

æœ€åä¸€æ­¥~ å¯¹äºä¸€ä¸ªæŸ¥è¯¢ç‚¹ `u`ï¼Œæˆ‘ä»¬è¦æ‰¾å®ƒæ·±åº¦æœ€æµ…çš„æœ‰æ•ˆç¥–å…ˆã€‚æˆ‘ä»¬å¯ä»¥å†è¿›è¡Œä¸€æ¬¡ DFS æ¥ä¼ é€’è¿™ä¸ªä¿¡æ¯ã€‚
è®¾ `ans_provider[u]` ä¸º `u` æ·±åº¦æœ€æµ…çš„æœ‰æ•ˆç¥–å…ˆã€‚
`ans_provider[p] = is_valid[p] ? p : ans_provider[parent[p]]`
è¿™ä¸ªé€’æ¨å…³ç³»å¯ä»¥åœ¨ä¸€æ¬¡è‡ªé¡¶å‘ä¸‹çš„ DFS ä¸­è½»æ¾å®Œæˆã€‚

é¢„å¤„ç†å®Œæ‰€æœ‰ç‚¹çš„ `ans_provider` åï¼Œå¯¹äºæ¯ä¸ªæŸ¥è¯¢ `(r, c)`ï¼Œå…¶å¯¹åº”çš„èŠ‚ç‚¹ä¸º `u`ï¼Œç­”æ¡ˆå°±æ˜¯ `val(ans_provider[u])`ï¼

æ€»ç»“ä¸€ä¸‹ï¼Œæˆ‘ä»¬çš„çˆªå°ğŸ¾éå¸ƒäº†ï¼š
`å¤šæºBFS` -> `Kruskalé‡æ„æ ‘` -> `å¯æ’¤é”€å¹¶æŸ¥é›†` + `ç¦»çº¿DFS` -> `ç­”æ¡ˆç»Ÿè®¡DFS`ã€‚
ä¸€æ•´å¥—ç»„åˆæ‹³ä¸‹æ¥ï¼Œé—®é¢˜å°±è§£å†³å•¦ï¼æ˜¯ä¸æ˜¯å¾ˆæœ‰è¶£ï¼Œå–µ~

## ä»£ç å®ç°

è¿™æ˜¯æœ¬å–µæ ¹æ®ä¸Šé¢çš„æ€è·¯ï¼Œç²¾å¿ƒé‡æ„çš„ä¸€ä»½ä»£ç å“¦ï¼åŠ äº†å¾ˆå¤šæ³¨é‡Šï¼Œå¸Œæœ›èƒ½å¸®åŠ©ä¸»äººç†è§£ï¼Œå–µ~

```cpp
#include <iostream>
#include <vector>
#include <string>
#include <queue>
#include <algorithm>
#include <numeric>

using namespace std;

const int INF = 0x3f3f3f3f;
const int MAXN = 505;
const int MAX_NODES = MAXN * MAXN;

// --- åŸºæœ¬å®šä¹‰ ---
int n, m, q;
char grid[MAXN][MAXN];
int val[MAX_NODES]; // ç‚¹æƒï¼šåˆ°æœ€è¿‘ç«å±±çš„æ›¼å“ˆé¡¿è·ç¦»
int node_id(int r, int c) { return (r - 1) * m + c; }
pair<int, int> node_coords(int id) {
    return {(id - 1) / m + 1, (id - 1) % m + 1};
}

// --- å¯æ’¤é”€å¹¶æŸ¥é›† ---
struct DSU_Rollback {
    vector<int> parent;
    vector<pair<int, int>> history; // è®°å½•(è¢«ä¿®æ”¹ä½ç½®, æ—§å€¼)

    DSU_Rollback(int size) : parent(size + 1) {
        iota(parent.begin(), parent.end(), 0);
    }

    int find(int i) {
        while (parent[i] != i) i = parent[i];
        return i;
    }

    void unite(int i, int j) {
        int root_i = find(i);
        int root_j = find(j);
        if (root_i != root_j) {
            history.push_back({root_j, parent[root_j]});
            parent[root_j] = root_i;
        }
    }

    int current_version() { return history.size(); }

    void rollback(int version) {
        while (history.size() > version) {
            auto [pos, old_val] = history.back();
            history.pop_back();
            parent[pos] = old_val;
        }
    }
};

// --- Kruskalé‡æ„æ ‘ç›¸å…³ ---
struct NodeInfo {
    int id;
    int value;
    bool operator>(const NodeInfo& other) const {
        return value > other.value;
    }
};
int dsu_kruskal[MAX_NODES];
int find_kruskal(int i) {
    return dsu_kruskal[i] == i ? i : dsu_kruskal[i] = find_kruskal(dsu_kruskal[i]);
}
void unite_kruskal(int i, int j) {
    int root_i = find_kruskal(i);
    int root_j = find_kruskal(j);
    if (root_i != root_j) dsu_kruskal[root_j] = root_i;
}

vector<int> recon_tree[MAX_NODES];
int recon_parent[MAX_NODES];
bool is_valid_provider[MAX_NODES];
int final_ans_provider[MAX_NODES];

// --- åæ ‡æ–¹å‘ ---
int dr4[] = {-1, 1, 0, 0};
int dc4[] = {0, 0, -1, 1};
int dr8[] = {-1, -1, -1, 0, 0, 1, 1, 1};
int dc8[] = {-1, 0, 1, -1, 1, -1, 0, 1};

void solve() {
    cin >> n >> m >> q;
    int total_nodes = n * m;

    // --- åˆå§‹åŒ– ---
    vector<NodeInfo> non_island_nodes;
    queue<pair<int, int>> q_bfs;
    for (int i = 1; i <= total_nodes; ++i) {
        val[i] = INF;
        recon_tree[i].clear();
        recon_parent[i] = 0;
        is_valid_provider[i] = false;
        dsu_kruskal[i] = i;
    }

    // --- 1. é¢„å¤„ç†ç‚¹æƒ (å¤šæºBFS) ---
    for (int i = 1; i <= n; ++i) {
        for (int j = 1; j <= m; ++j) {
            cin >> grid[i][j];
            if (grid[i][j] == 'v') {
                q_bfs.push({i, j});
                val[node_id(i, j)] = 0;
            }
            if (grid[i][j] != '#') {
                non_island_nodes.push_back({node_id(i, j), 0});
            }
        }
    }

    while (!q_bfs.empty()) {
        auto [r, c] = q_bfs.front();
        q_bfs.pop();
        int u = node_id(r, c);
        for (int i = 0; i < 4; ++i) {
            int nr = r + dr4[i];
            int nc = c + dc4[i];
            if (nr >= 1 && nr <= n && nc >= 1 && nc <= m) {
                int v = node_id(nr, nc);
                if (val[v] > val[u] + 1) {
                    val[v] = val[u] + 1;
                    q_bfs.push({nr, nc});
                }
            }
        }
    }
    
    for (auto& node : non_island_nodes) {
        node.value = val[node.id];
    }

    // --- 2. Kruskalé‡æ„æ ‘ ---
    sort(non_island_nodes.begin(), non_island_nodes.end(), greater<NodeInfo>());
    vector<bool> processed(total_nodes + 1, false);

    for (const auto& node : non_island_nodes) {
        int u = node.id;
        processed[u] = true;
        auto [r, c] = node_coords(u);
        for (int i = 0; i < 4; ++i) {
            int nr = r + dr4[i];
            int nc = c + dc4[i];
            if (nr >= 1 && nr <= n && nc >= 1 && nc <= m && grid[nr][nc] != '#') {
                int v = node_id(nr, nc);
                if (processed[v] && find_kruskal(u) != find_kruskal(v)) {
                    int root_v = find_kruskal(v);
                    recon_tree[u].push_back(root_v);
                    recon_parent[root_v] = u;
                    unite_kruskal(u, v);
                }
            }
        }
    }

    // --- 3. ç¦»çº¿æ£€æŸ¥è¿é€šæ€§ (DFS + å¯æ’¤é”€å¹¶æŸ¥é›†) ---
    int S = total_nodes + 1, T = total_nodes + 2;
    DSU_Rollback dsu_conn(total_nodes + 2);
    vector<bool> active_nodes(total_nodes + 1, false);

    function<void(int)> check_connectivity_dfs = 
        [&](int u) {
        int version = dsu_conn.current_version();
        active_nodes[u] = true;

        auto [r, c] = node_coords(u);
        for (int i = 0; i < 8; ++i) {
            int nr = r + dr8[i];
            int nc = c + dc8[i];
            if (nr < 1 || nr > n || nc < 1 || nc > m) { // è¾¹ç•Œ
                dsu_conn.unite(u, S);
                continue;
            }
            int v = node_id(nr, nc);
            if (grid[nr][nc] == '#') { // å²›å±¿
                dsu_conn.unite(u, T);
            } else if (active_nodes[v]) { // å·²æ¿€æ´»çš„é‚»å±…
                dsu_conn.unite(u, v);
            }
        }

        if (dsu_conn.find(S) == dsu_conn.find(T)) {
            is_valid_provider[u] = true;
        }

        for (int child : recon_tree[u]) {
            check_connectivity_dfs(child);
        }

        active_nodes[u] = false;
        dsu_conn.rollback(version);
    };

    for (const auto& node : non_island_nodes) {
        if (recon_parent[node.id] == 0) { // æ˜¯æ£®æ—ä¸­çš„ä¸€æ£µæ ‘çš„æ ¹
            check_connectivity_dfs(node.id);
        }
    }

    // --- 4. ç»Ÿè®¡æœ€ç»ˆç­”æ¡ˆ ---
    function<void(int, int)> compute_final_ans_dfs = 
        [&](int u, int provider_p) {
        if (is_valid_provider[u]) {
            provider_p = u;
        }
        final_ans_provider[u] = provider_p;
        for (int child : recon_tree[u]) {
            compute_final_ans_dfs(child, provider_p);
        }
    };
    
    for (const auto& node : non_island_nodes) {
        if (recon_parent[node.id] == 0) {
            compute_final_ans_dfs(node.id, 0);
        }
    }

    // --- 5. å›ç­”æŸ¥è¯¢ ---
    while (q--) {
        int r, c;
        cin >> r >> c;
        int u = node_id(r, c);
        int provider_id = final_ans_provider[u];
        if (provider_id == 0) { // ç†è®ºä¸Šä¸ä¼šå‘ç”Ÿï¼Œå› ä¸ºä¿è¯æœ‰è§£
            cout << 0 << "\n";
        } else {
            cout << val[provider_id] << "\n";
        }
    }
}

int main() {
    ios_base::sync_with_stdio(false);
    cin.tie(NULL);
    int t;
    cin >> t;
    while (t--) {
        solve();
    }
    return 0;
}
```

## å¤æ‚åº¦åˆ†æ

*   **æ—¶é—´å¤æ‚åº¦**:
    1.  å¤šæºBFSé¢„å¤„ç†ç‚¹æƒï¼šæ¯ä¸ªç‚¹å’Œè¾¹æœ€å¤šè®¿é—®ä¸€æ¬¡ï¼Œå¤æ‚åº¦ä¸º $O(N \times M)$ã€‚
    2.  Kruskalé‡æ„æ ‘ï¼šä¸»è¦å¼€é”€åœ¨äºå¯¹æ‰€æœ‰éå²›å±¿ç‚¹ï¼ˆæœ€å¤š $N \times M$ ä¸ªï¼‰è¿›è¡Œæ’åºï¼Œå¤æ‚åº¦ä¸º $O(NM \log(NM))$ã€‚ä¹‹åå»ºæ ‘çš„è¿‡ç¨‹ï¼Œæ¯ä¸ªç‚¹å¤„ç†ä¸€æ¬¡ï¼Œå¹¶æŸ¥é›†æ“ä½œè¿‘ä¹å¸¸æ•°ï¼Œæ€»å…±æ˜¯ $O(NM \cdot \alpha(NM))$ã€‚
    3.  ç¦»çº¿æ£€æŸ¥è¿é€šæ€§ï¼šå¯¹é‡æ„æ ‘è¿›è¡Œä¸€æ¬¡DFSï¼ŒèŠ‚ç‚¹æ•°ä¸º $O(NM)$ã€‚åœ¨æ¯ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘ä»¬æ£€æŸ¥8ä¸ªé‚»å±…ï¼Œå¹¶æ‰§è¡Œå¸¸æ•°æ¬¡å¯æ’¤é”€å¹¶æŸ¥é›†æ“ä½œã€‚å¹¶æŸ¥é›†æ“ä½œçš„å¤æ‚åº¦ä¸º $O(\log(NM))$ã€‚æ‰€ä»¥è¿™éƒ¨åˆ†æ€»å¤æ‚åº¦ä¸º $O(NM \log(NM))$ã€‚
    4.  ç»Ÿè®¡ç­”æ¡ˆï¼šä¸€æ¬¡DFSï¼Œå¤æ‚åº¦ä¸º $O(NM)$ã€‚

    ç»¼ä¸Šï¼Œæ€»çš„æ—¶é—´å¤æ‚åº¦è¢«æ’åºå’Œç¦»çº¿DFSä¸»å¯¼ï¼Œä¸º $O(NM \log(NM))$ï¼Œéå¸¸é«˜æ•ˆï¼Œå–µ~

*   **ç©ºé—´å¤æ‚åº¦**:
    æˆ‘ä»¬éœ€è¦å­˜å‚¨åœ°å›¾ã€ç‚¹æƒæ•°ç»„ã€é‡æ„æ ‘çš„é‚»æ¥è¡¨ã€å¹¶æŸ¥é›†ç­‰ã€‚è¿™äº›æ•°æ®ç»“æ„çš„å¤§å°éƒ½ä¸åœ°å›¾å¤§å° $N \times M$ æˆæ­£æ¯”ã€‚æ‰€ä»¥ç©ºé—´å¤æ‚åº¦æ˜¯ $O(N \times M)$ã€‚

## çŸ¥è¯†ç‚¹æ€»ç»“

è¿™é“é¢˜æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ç»¼åˆé¢˜ï¼ŒæŠŠå¥½å‡ ä¸ªé«˜çº§ç®—æ³•æ€æƒ³å·§å¦™åœ°ç»“åˆåœ¨äº†ä¸€èµ·ï¼Œåƒä¸€ç›˜ç²¾è‡´çš„çŒ«é¥­ï¼Œå–µ~

1.  **é—®é¢˜è½¬åŒ–**: èƒ½å¤Ÿå°†â€œæœ€å¤§åŒ–æœ€å°å€¼â€é—®é¢˜ä¸**æœ€å¤§ç“¶é¢ˆè·¯**è”ç³»èµ·æ¥ï¼Œå¹¶å°†â€œåŒ…å›´â€æŠ½è±¡ä¸ºå›¾è®ºä¸­çš„**S-Tå‰²**ï¼Œæ˜¯è§£é¢˜çš„ç¬¬ä¸€æ­¥ã€‚
2.  **Kruskalé‡æ„æ ‘**: å®ƒæ˜¯è§£å†³æœ€å¤§ç“¶é¢ˆè·¯ã€æŸ¥è¯¢ç‰¹å®šé˜ˆå€¼ä¸‹è¿é€šæ€§çš„å¼ºå¤§å·¥å…·ã€‚é€šè¿‡æŒ‰æƒå€¼æ’åºå¹¶ç”¨å¹¶æŸ¥é›†åˆå¹¶ï¼Œå°†ä¸€ä¸ªå›¾çš„è¿é€šæ€§ä¿¡æ¯å‹ç¼©åˆ°ä¸€æ£µæ ‘çš„ç»“æ„ä¸­ï¼Œéå¸¸ä¼˜é›…ã€‚
3.  **ç¦»çº¿æ€æƒ³**: å½“æŸ¥è¯¢ä¹‹é—´æœ‰å…³è”ï¼ˆå¦‚æ­¤å¤„çš„å­æ ‘æŸ¥è¯¢ï¼‰ï¼Œæˆ–è€…å¯ä»¥è¢«é¢„å…ˆå¤„ç†æ—¶ï¼Œç¦»çº¿ç®—æ³•å¾€å¾€èƒ½å¤§å¤§ä¼˜åŒ–å¤æ‚åº¦ã€‚è¿™é‡Œæˆ‘ä»¬å°†æ‰€æœ‰èŠ‚ç‚¹çš„è¿é€šæ€§æŸ¥è¯¢é€šè¿‡ä¸€æ¬¡DFSå…¨éƒ¨æå®šã€‚
4.  **å¯æ’¤é”€å¹¶æŸ¥é›†**: è¿™æ˜¯å¤„ç†éœ€è¦â€œæ’¤é”€â€æ“ä½œçš„åŠ¨æ€å›¾è¿é€šæ€§é—®é¢˜çš„æ ‡å‡†å·¥å…·ã€‚åœ¨DFSä¸­ï¼Œè¿›å…¥å­é—®é¢˜æ—¶ä¿®æ”¹æ•°æ®ç»“æ„ï¼Œé€€å‡ºæ—¶æ¢å¤åŸçŠ¶ï¼Œå¯æ’¤é”€å¹¶æŸ¥é›†æ˜¯å®Œç¾çš„é€‰æ‹©ã€‚

å¸Œæœ›è¿™ç¯‡é¢˜è§£èƒ½å¸®åˆ°ä½ å“¦ï¼å¦‚æœè¿˜æœ‰ä¸æ˜ç™½çš„åœ°æ–¹ï¼Œéšæ—¶å¯ä»¥å†æ¥é—®æœ¬å–µï¼Œå–µ~ åŠ æ²¹ï¼